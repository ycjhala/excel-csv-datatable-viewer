<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Excel/CSV DataTable Viewer</title>
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-dt/1.13.6/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-buttons-dt/2.4.2/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-searchpanes-dt/2.2.0/searchPanes.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-select-dt/1.7.0/select.dataTables.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .upload-section {
            padding: 40px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .file-upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .file-upload-area:hover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.05);
        }
        
        .file-upload-area.dragover {
            border-color: #00f2fe;
            background: rgba(0, 242, 254, 0.1);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #4facfe;
            margin-bottom: 20px;
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .upload-text {
            font-size: 1.3rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: #999;
            font-size: 0.9rem;
        }
        
        .progress-container {
            display: none;
            margin-top: 30px;
        }
        
        .progress-bar {
            background: #f0f0f0;
            border-radius: 25px;
            overflow: hidden;
            height: 25px;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 25px;
            position: relative;
        }
        
        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #333;
        }
        
        .config-section {
            padding: 30px 40px;
            background: #f8f9fa;
            border-bottom: 2px solid #f0f0f0;
            display: none;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .config-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .config-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        
        .checkbox-item:hover {
            background: #f0f8ff;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group select, .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .apply-config-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
        }
        
        .apply-config-btn:hover {
            transform: translateY(-2px);
        }
        
        .table-section {
            padding: 40px;
            display: none;
        }
        
        .dataTables_wrapper {
            margin-top: 20px;
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        table.dataTable {
            width: 100% !important;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        table.dataTable thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 10px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        table.dataTable tbody tr {
            transition: background-color 0.2s ease;
        }
        
        table.dataTable tbody tr:hover {
            background-color: #f8f9ff;
        }
        
        table.dataTable tbody td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        .editable-cell {
            cursor: pointer;
            position: relative;
        }
        
        .editable-cell:hover {
            background: #fff3cd;
        }
        
        .cell-editor {
            width: 100%;
            border: 2px solid #4facfe;
            padding: 8px;
            font-size: 0.9rem;
            border-radius: 4px;
        }
        
        .edit-controls {
            margin-top: 20px;
            text-align: center;
        }
        
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #4facfe;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dt-searchPanes {
            margin-bottom: 20px;
        }
        
        .dt-searchPane {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .file-info {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4facfe;
        }
        
        .file-info h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .file-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .file-stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .file-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4facfe;
        }
        
        .file-stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-section, .table-section {
                padding: 20px;
            }
            
            .file-upload-area {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Processing your file...</h3>
            <p>Please wait while we load and process your data.</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìä Advanced Excel/CSV Viewer</h1>
            <p>Upload, analyze, and manage your data with powerful interactive tools</p>
        </div>

        <div class="upload-section">
            <div class="file-upload-area" id="fileUploadArea">
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" multiple>
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop your Excel or CSV files here</div>
                <div class="upload-hint">or click to browse (supports .xlsx, .xls, .csv)</div>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Processing...</div>
            </div>
        </div>

        <div class="config-section" id="configSection">
            <div class="file-info" id="fileInfo"></div>
            
            <div class="config-grid">
                <div class="config-card">
                    <h3>üìã Table Configuration</h3>
                    <div class="form-group">
                        <label>Rows per page:</label>
                        <select id="pageLength">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="500">500</option>
                            <option value="-1">All</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="scrollX" checked> Enable horizontal scroll
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="fixedHeader" checked> Fixed header
                        </label>
                    </div>
                </div>

                <div class="config-card">
                    <h3>üîç Search Panes</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableSearchPanes" checked> Enable search panes
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Columns for search panes:</label>
                        <div id="searchPaneColumns" class="checkbox-group"></div>
                    </div>
                </div>

                <div class="config-card">
                    <h3>‚úèÔ∏è Editing Options</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableEditing" checked> Enable cell editing
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableRowEditing" checked> Enable row editing
                        </label>
                    </div>
                </div>

                <div class="config-card">
                    <h3>üì§ Export Options</h3>
                    <div class="form-group">
                        <label>Available export formats:</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="exportCsv" checked> CSV</label>
                            <label><input type="checkbox" id="exportExcel" checked> Excel</label>
                            <label><input type="checkbox" id="exportPdf" checked> PDF</label>
                        </div>
                    </div>
                </div>
            </div>

            <button class="apply-config-btn" onclick="applyConfiguration()">Apply Configuration & Load Table</button>
        </div>

        <div class="table-section" id="tableSection">
            <div class="edit-controls">
                <button class="btn btn-primary" onclick="addNewRow()">‚ûï Add Row</button>
                <button class="btn btn-success" onclick="saveChanges()">üíæ Save Changes</button>
                <button class="btn btn-danger" onclick="deleteSelectedRows()">üóëÔ∏è Delete Selected</button>
            </div>
            <div class="table-responsive">
                <table id="dataTable" class="display" style="width:100%"></table>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables.net/1.13.6/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-buttons/2.4.2/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-buttons/2.4.2/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-buttons/2.4.2/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-searchpanes/2.2.0/dataTables.searchPanes.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-select/1.7.0/dataTables.select.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <script>
        let globalData = [];
        let globalColumns = [];
        let dataTable = null;
        let editedCells = new Map();
        let currentFileName = '';

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        const fileUploadArea = document.getElementById('fileUploadArea');
        fileUploadArea.addEventListener('dragover', handleDragOver);
        fileUploadArea.addEventListener('drop', handleFileDrop);

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            fileUploadArea.classList.add('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            fileUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFiles(files);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                processFiles(files);
            }
        }

        function processFiles(files) {
            if (files.length === 0) return;
            
            // For now, process the first file
            const file = files[0];
            currentFileName = file.name;
            
            showProgress();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                setTimeout(() => {
                    try {
                        if (file.name.toLowerCase().endsWith('.csv')) {
                            parseCSV(e.target.result);
                        } else {
                            parseExcel(e.target.result);
                        }
                    } catch (error) {
                        console.error('Error processing file:', error);
                        alert('Error processing file: ' + error.message);
                        hideProgress();
                    }
                }, 100);
            };

            reader.onerror = function() {
                alert('Error reading file');
                hideProgress();
            };

            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(data) {
            updateProgress(20, 'Parsing CSV data...');
            
            const lines = data.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) {
                throw new Error('CSV file is empty');
            }

            // Simple CSV parsing with proper quote handling
            const rows = lines.map(line => {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"' && !inQuotes) {
                        inQuotes = true;
                    } else if (char === '"' && inQuotes && nextChar === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else if (char === '"' && inQuotes) {
                        inQuotes = false;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            });

            updateProgress(50, 'Processing data structure...');
            
            const headers = rows[0];
            const dataRows = rows.slice(1);
            
            processData(headers, dataRows);
        }

        function parseExcel(data) {
            updateProgress(20, 'Parsing Excel file...');
            
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            
            updateProgress(40, 'Converting to JSON...');
            
            // Convert to JSON with header row
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                header: 1, 
                defval: '',
                raw: false
            });
            
            if (jsonData.length === 0) {
                throw new Error('Excel file is empty');
            }

            updateProgress(60, 'Processing merged cells...');
            
            // Handle merged cells by duplicating data
            const merges = firstSheet['!merges'] || [];
            merges.forEach(merge => {
                const startRow = merge.s.r;
                const endRow = merge.e.r;
                const startCol = merge.s.c;
                const endCol = merge.e.c;
                
                // Get the value from the top-left cell of the merged range
                const sourceValue = jsonData[startRow] && jsonData[startRow][startCol] ? jsonData[startRow][startCol] : '';
                
                // Duplicate the value across all cells in the merged range
                for (let row = startRow; row <= endRow; row++) {
                    if (!jsonData[row]) jsonData[row] = [];
                    for (let col = startCol; col <= endCol; col++) {
                        jsonData[row][col] = sourceValue;
                    }
                }
            });

            const headers = jsonData[0] || [];
            const dataRows = jsonData.slice(1);
            
            processData(headers, dataRows);
        }

        function processData(headers, rows) {
            updateProgress(70, 'Structuring data...');
            
            // Clean headers and ensure uniqueness
            const cleanHeaders = headers.map((header, index) => {
                let cleanHeader = String(header).trim() || `Column_${index + 1}`;
                return cleanHeader;
            });
            
            // Ensure header uniqueness
            const uniqueHeaders = [];
            cleanHeaders.forEach((header, index) => {
                let uniqueHeader = header;
                let counter = 1;
                while (uniqueHeaders.includes(uniqueHeader)) {
                    uniqueHeader = `${header}_${counter}`;
                    counter++;
                }
                uniqueHeaders.push(uniqueHeader);
            });

            updateProgress(85, 'Finalizing data structure...');
            
            // Convert rows to objects
            const processedData = rows.map((row, rowIndex) => {
                const rowObj = { _rowId: rowIndex };
                uniqueHeaders.forEach((header, colIndex) => {
                    rowObj[header] = row[colIndex] || '';
                });
                return rowObj;
            });

            globalData = processedData;
            globalColumns = uniqueHeaders;
            
            updateProgress(100, 'Complete!');
            
            setTimeout(() => {
                hideProgress();
                showConfiguration();
            }, 500);
        }

        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = 'Processing...';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function showConfiguration() {
            // Show file information
            const fileInfo = document.getElementById('fileInfo');
            const totalRows = globalData.length;
            const totalCols = globalColumns.length;
            const fileSize = (JSON.stringify(globalData).length / 1024 / 1024).toFixed(2);
            
            fileInfo.innerHTML = `
                <h4>üìÑ File: ${currentFileName}</h4>
                <div class="file-stats">
                    <div class="file-stat">
                        <div class="file-stat-value">${totalRows.toLocaleString()}</div>
                        <div class="file-stat-label">Rows</div>
                    </div>
                    <div class="file-stat">
                        <div class="file-stat-value">${totalCols}</div>
                        <div class="file-stat-label">Columns</div>
                    </div>
                    <div class="file-stat">
                        <div class="file-stat-value">${fileSize} MB</div>
                        <div class="file-stat-label">Size</div>
                    </div>
                </div>
            `;

            // Populate search pane columns
            const searchPaneColumns = document.getElementById('searchPaneColumns');
            searchPaneColumns.innerHTML = '';
            
            globalColumns.forEach((col, index) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="searchPane_${index}" value="${index}" ${index < 5 ? 'checked' : ''}>
                    <label for="searchPane_${index}">${col}</label>
                `;
                searchPaneColumns.appendChild(div);
            });

            document.getElementById('configSection').style.display = 'block';
        }

        function applyConfiguration() {
            showLoadingOverlay();
            
            setTimeout(() => {
                try {
                    initializeDataTable();
                    hideLoadingOverlay();
                    document.getElementById('tableSection').style.display = 'block';
                    document.getElementById('tableSection').scrollIntoView({ behavior: 'smooth' });
                } catch (error) {
                    hideLoadingOverlay();
                    console.error('Error initializing table:', error);
                    alert('Error initializing table: ' + error.message);
                }
            }, 100);
        }

        function initializeDataTable() {
            // Destroy existing table if it exists
            if (dataTable) {
                dataTable.destroy();
                $('#dataTable').empty();
            }

            // Get configuration
            const pageLength = parseInt(document.getElementById('pageLength').value);
            const scrollX = document.getElementById('scrollX').checked;
            const fixedHeader = document.getElementById('fixedHeader').checked;
            const enableSearchPanes = document.getElementById('enableSearchPanes').checked;
            const enableEditing = document.getElementById('enableEditing').checked;

            // Get selected search pane columns
            const searchPaneColumns = Array.from(document.querySelectorAll('#searchPaneColumns input:checked'))
                .map(cb => parseInt(cb.value));

            // Get export options
            const exportButtons = [];
            if (document.getElementById('exportCsv').checked) {
                exportButtons.push('csv');
            }
            if (document.getElementById('exportExcel').checked) {
                exportButtons.push('excel');
            }
            if (document.getElementById('exportPdf').checked) {
                exportButtons.push('pdf');
            }

            // Prepare columns
            const columns = globalColumns.map((col, index) => ({
                title: col,
                data: col,
                name: col,
                searchPanes: {
                    show: searchPaneColumns.includes(index)
                },
                className: enableEditing ? 'editable-cell' : ''
            }));

            // DataTable configuration
            const config = {
                data: globalData,
                columns: columns,
                pageLength: pageLength === -1 ? globalData.length : pageLength,
                scrollX: scrollX,
                scrollY: '600px',
                scrollCollapse: true,
                fixedHeader: fixedHeader,
                select: {
                    style: 'multi',
                    selector: 'td:first-child'
                },
                dom: enableSearchPanes ? 'Plfrtip' : 'Blfrtip',
                buttons: [
                    {
                        extend: 'collection',
                        text: 'üì§ Export',
                        buttons: exportButtons.map(format => ({
                            extend: format,
                            text: format.toUpperCase(),
                            exportOptions: {
                                modifier: {
                                    search: 'applied',
                                    order: 'applied'
                                }
                            }
                        }))
                    },
                    {
                        text: 'üîÑ Reload',
                        action: function() {
                            dataTable.ajax.reload();
                        }
                    }
                ],
                searchPanes: enableSearchPanes ? {
                    columns: searchPaneColumns,
                    cascadePanes: true,
                    viewTotal: true,
                    layout: 'columns-3'
                } : false,
                columnDefs: [
                    {
                        targets: '_all',
                        createdCell: function(td, cellData, rowData, row, col) {
                            if (enableEditing) {
                                $(td).attr('title', 'Click to edit');
                            }
                        }
                    }
                ],
                language: {
                    processing: "Processing large dataset...",
                    loadingRecords: "Loading records...",
                    paginate: {
                        first: "‚èÆÔ∏è",
                        last: "‚è≠Ô∏è", 
                        next: "‚ñ∂Ô∏è",
                        previous: "‚óÄÔ∏è"
                    },
                    search: "üîç Search:",
                    lengthMenu: "Show _MENU_ entries per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries"
                },
                processing: true,
                deferRender: true,
                stateSave: true
            };

            // Initialize DataTable
            dataTable = $('#dataTable').DataTable(config);

            // Add cell editing functionality
            if (enableEditing) {
                $('#dataTable tbody').on('click', 'td.editable-cell', function() {
                    editCell(this);
                });
            }

            // Add row selection styling
            $('#dataTable tbody').on('click', 'tr', function() {
                $(this).toggleClass('selected');
            });
        }

        function editCell(cell) {
            const $cell = $(cell);
            const currentValue = $cell.text();
            const rowIndex = dataTable.row(cell).index();
            const columnIndex = dataTable.column(cell).index();
            const columnName = globalColumns[columnIndex];

            // Don't edit if already being edited
            if ($cell.find('.cell-editor').length > 0) {
                return;
            }

            // Create input element
            const $input = $('<input type="text" class="cell-editor">');
            $input.val(currentValue);

            // Replace cell content with input
            $cell.html($input);
            $input.focus().select();

            // Handle save on Enter or blur
            $input.on('blur keypress', function(e) {
                if (e.type === 'blur' || e.which === 13) {
                    const newValue = $input.val();
                    $cell.html(newValue);
                    
                    // Update data
                    const rowData = dataTable.row(rowIndex).data();
                    rowData[columnName] = newValue;
                    
                    // Track changes
                    const cellId = `${rowIndex}_${columnIndex}`;
                    editedCells.set(cellId, {
                        row: rowIndex,
                        column: columnName,
                        oldValue: currentValue,
                        newValue: newValue
                    });

                    // Update row data
                    dataTable.row(rowIndex).data(rowData);
                }
            });

            // Handle Escape to cancel
            $input.on('keypress', function(e) {
                if (e.which === 27) { // Escape
                    $cell.html(currentValue);
                }
            });
        }

        function addNewRow() {
            const newRow = { _rowId: globalData.length };
            globalColumns.forEach(col => {
                newRow[col] = '';
            });
            
            globalData.push(newRow);
            dataTable.row.add(newRow).draw();
            
            // Scroll to the new row
            const lastPageInfo = dataTable.page.info();
            dataTable.page(lastPageInfo.pages - 1).draw('page');
        }

        function deleteSelectedRows() {
            const selectedRows = dataTable.rows('.selected');
            
            if (selectedRows.count() === 0) {
                alert('Please select rows to delete');
                return;
            }

            if (confirm(`Are you sure you want to delete ${selectedRows.count()} row(s)?`)) {
                selectedRows.remove().draw();
                
                // Update global data
                const remainingData = [];
                dataTable.rows().every(function() {
                    remainingData.push(this.data());
                });
                globalData = remainingData;
            }
        }

        function saveChanges() {
            if (editedCells.size === 0 && globalData.length > 0) {
                // Create download of current data
                downloadModifiedData();
                return;
            }

            const changes = Array.from(editedCells.values());
            
            if (changes.length === 0) {
                alert('No changes to save');
                return;
            }

            // Show changes summary
            let changesSummary = `Save ${changes.length} changes?\n\n`;
            changes.slice(0, 5).forEach(change => {
                changesSummary += `Row ${change.row + 1}, ${change.column}: "${change.oldValue}" ‚Üí "${change.newValue}"\n`;
            });
            
            if (changes.length > 5) {
                changesSummary += `... and ${changes.length - 5} more changes`;
            }

            if (confirm(changesSummary)) {
                downloadModifiedData();
                editedCells.clear();
            }
        }

        function downloadModifiedData() {
            // Get current table data (including any filters/sorts)
            const tableData = [];
            dataTable.rows({ search: 'applied' }).every(function() {
                const rowData = this.data();
                const cleanRow = {};
                globalColumns.forEach(col => {
                    cleanRow[col] = rowData[col];
                });
                tableData.push(cleanRow);
            });

            // Determine file extension from original filename
            const originalExt = currentFileName.split('.').pop().toLowerCase();
            let downloadExt = originalExt;
            
            if (originalExt === 'xls' || originalExt === 'xlsx') {
                downloadExt = 'xlsx';
                downloadAsExcel(tableData, `modified_${currentFileName.replace(/\.[^/.]+$/, '')}.${downloadExt}`);
            } else {
                downloadExt = 'csv';
                downloadAsCSV(tableData, `modified_${currentFileName.replace(/\.[^/.]+$/, '')}.${downloadExt}`);
            }
        }

        function downloadAsExcel(data, filename) {
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Data');
            XLSX.writeFile(workbook, filename);
        }

        function downloadAsCSV(data, filename) {
            if (data.length === 0) return;
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header] || '';
                        // Escape quotes and wrap in quotes if contains comma, quote, or newline
                        if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Remove dragover class when leaving the upload area
        fileUploadArea.addEventListener('dragleave', function(e) {
            if (!fileUploadArea.contains(e.relatedTarget)) {
                fileUploadArea.classList.remove('dragover');
            }
        });

        // Prevent default drag behaviors on the whole document
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Reset upload area on page load
        window.addEventListener('load', function() {
            document.getElementById('fileInput').value = '';
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (dataTable) {
                    saveChanges();
                }
            }
            
            // Delete key to delete selected rows
            if (e.key === 'Delete' && dataTable) {
                const selectedRows = dataTable.rows('.selected');
                if (selectedRows.count() > 0) {
                    deleteSelectedRows();
                }
            }
        });

        // Auto-save reminder
        setInterval(function() {
            if (editedCells.size > 0) {
                console.log(`You have ${editedCells.size} unsaved changes`);
            }
        }, 30000); // Every 30 seconds

        // Performance monitoring
        function logPerformance(label, startTime) {
            const endTime = performance.now();
            const duration = (endTime - startTime).toFixed(2);
            console.log(`${label}: ${duration}ms`);
        }

        // Error handling for large datasets
        window.addEventListener('error', function(e) {
            console.error('Application error:', e.error);
            if (e.error.message.includes('Maximum call stack') || 
                e.error.message.includes('out of memory')) {
                alert('Dataset too large for browser memory. Try using a smaller file or enable pagination.');
            }
        });

        // Memory usage monitoring (if available)
        if ('memory' in performance) {
            setInterval(function() {
                const memory = performance.memory;
                const usedMB = (memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
                const totalMB = (memory.totalJSHeapSize / 1024 / 1024).toFixed(2);
                
                if (usedMB > 500) { // Warning at 500MB
                    console.warn(`High memory usage: ${usedMB}MB / ${totalMB}MB`);
                }
            }, 10000); // Every 10 seconds
        }
    </script>
</body>
</html>'